@using BlazorWebFormsComponents.Enums

@code {

	bool modeChangingFired = false;
	bool modeChangedFired = false;
	DetailsViewMode? newModeFromEvent = null;
	bool itemDeletingFired = false;
	bool itemDeletedFired = false;
	bool itemUpdatingFired = false;
	bool itemUpdatedFired = false;
	bool itemInsertingFired = false;
	bool itemInsertedFired = false;

	[Fact]
	public void DetailsView_EditClick_FiresModeChangingAndModeChanged()
	{
		modeChangingFired = false;
		modeChangedFired = false;
		newModeFromEvent = null;

		var items = Widget.SimpleWidgetList.Take(1).ToList();
		var cut = Render(@<DetailsView Items="items" ItemType="Widget"
			AutoGenerateEditButton="true"
			AutoGenerateRows="true"
			ModeChanging="OnModeChanging"
			ModeChanged="OnModeChanged" />);

		cut.FindAll("a").First(a => a.TextContent == "Edit").Click();

		modeChangingFired.ShouldBeTrue("ModeChanging event should fire");
		modeChangedFired.ShouldBeTrue("ModeChanged event should fire");
		newModeFromEvent.ShouldBe(DetailsViewMode.Edit);
	}

	[Fact]
	public void DetailsView_DeleteClick_FiresItemDeletingAndItemDeleted()
	{
		itemDeletingFired = false;
		itemDeletedFired = false;

		var items = Widget.SimpleWidgetList.Take(1).ToList();
		var cut = Render(@<DetailsView Items="items" ItemType="Widget"
			AutoGenerateDeleteButton="true"
			AutoGenerateRows="true"
			ItemDeleting="OnItemDeleting"
			ItemDeleted="OnItemDeleted" />);

		cut.FindAll("a").First(a => a.TextContent == "Delete").Click();

		itemDeletingFired.ShouldBeTrue("ItemDeleting event should fire");
		itemDeletedFired.ShouldBeTrue("ItemDeleted event should fire");
	}

	[Fact]
	public void DetailsView_UpdateClick_FiresItemUpdatingAndItemUpdated()
	{
		itemUpdatingFired = false;
		itemUpdatedFired = false;

		var items = Widget.SimpleWidgetList.Take(1).ToList();
		var cut = Render(@<DetailsView Items="items" ItemType="Widget"
			AutoGenerateEditButton="true"
			AutoGenerateRows="true"
			ItemUpdating="OnItemUpdating"
			ItemUpdated="OnItemUpdated" />);

		// Enter edit mode
		cut.FindAll("a").First(a => a.TextContent == "Edit").Click();
		// Click Update
		cut.FindAll("a").First(a => a.TextContent == "Update").Click();

		itemUpdatingFired.ShouldBeTrue("ItemUpdating event should fire");
		itemUpdatedFired.ShouldBeTrue("ItemUpdated event should fire");
	}

	[Fact]
	public void DetailsView_InsertClick_FiresItemInsertingAndItemInserted()
	{
		itemInsertingFired = false;
		itemInsertedFired = false;

		var items = Widget.SimpleWidgetList.Take(1).ToList();
		var cut = Render(@<DetailsView Items="items" ItemType="Widget"
			AutoGenerateInsertButton="true"
			AutoGenerateRows="true"
			ItemInserting="OnItemInserting"
			ItemInserted="OnItemInserted" />);

		// Enter insert mode
		cut.FindAll("a").First(a => a.TextContent == "New").Click();
		// Click Insert
		cut.FindAll("a").First(a => a.TextContent == "Insert").Click();

		itemInsertingFired.ShouldBeTrue("ItemInserting event should fire");
		itemInsertedFired.ShouldBeTrue("ItemInserted event should fire");
	}

	[Fact]
	public void DetailsView_CancelAfterEdit_FiresModeChangingWithCancelFlag()
	{
		modeChangingFired = false;
		bool cancelingEditFlag = false;

		var items = Widget.SimpleWidgetList.Take(1).ToList();
		var cut = Render(@<DetailsView Items="items" ItemType="Widget"
			AutoGenerateEditButton="true"
			AutoGenerateRows="true"
			ModeChanging="@((DetailsViewModeEventArgs e) => { modeChangingFired = true; cancelingEditFlag = e.CancelingEdit; })" />);

		// Enter edit mode
		cut.FindAll("a").First(a => a.TextContent == "Edit").Click();
		modeChangingFired = false;
		// Cancel
		cut.FindAll("a").First(a => a.TextContent == "Cancel").Click();

		modeChangingFired.ShouldBeTrue("ModeChanging should fire on cancel");
		cancelingEditFlag.ShouldBeTrue("CancelingEdit should be true when canceling");
	}

	[Fact]
	public void DetailsView_UpdateClick_ReturnToReadOnlyMode()
	{
		var items = Widget.SimpleWidgetList.Take(1).ToList();
		var cut = Render(@<DetailsView Items="items" ItemType="Widget"
			AutoGenerateEditButton="true"
			AutoGenerateRows="true" />);

		// Enter edit mode
		cut.FindAll("a").First(a => a.TextContent == "Edit").Click();
		// Click Update
		cut.FindAll("a").First(a => a.TextContent == "Update").Click();

		// Should return to ReadOnly mode
		var links = cut.FindAll("a");
		links.Any(a => a.TextContent == "Edit").ShouldBeTrue("Should return to read-only mode after update");
	}

	void OnModeChanging(DetailsViewModeEventArgs args)
	{
		modeChangingFired = true;
		newModeFromEvent = args.NewMode;
	}

	void OnModeChanged(DetailsViewModeEventArgs args)
	{
		modeChangedFired = true;
	}

	void OnItemDeleting(DetailsViewDeleteEventArgs args)
	{
		itemDeletingFired = true;
	}

	void OnItemDeleted(DetailsViewDeletedEventArgs args)
	{
		itemDeletedFired = true;
	}

	void OnItemUpdating(DetailsViewUpdateEventArgs args)
	{
		itemUpdatingFired = true;
	}

	void OnItemUpdated(DetailsViewUpdatedEventArgs args)
	{
		itemUpdatedFired = true;
	}

	void OnItemInserting(DetailsViewInsertEventArgs args)
	{
		itemInsertingFired = true;
	}

	void OnItemInserted(DetailsViewInsertedEventArgs args)
	{
		itemInsertedFired = true;
	}
}
