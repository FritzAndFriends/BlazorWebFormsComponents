@inherits BunitContext
@using System.Security.Claims;
@using Microsoft.AspNetCore.Components.Authorization
@using BlazorWebFormsComponents.LoginControls;
@using Moq;

@code {
	Login loginControl = new Login();
	bool isAuthenticated = false;

	[Fact]
	public void Login_Authenticate_ValidatesCredentials()
	{
		var principal = new ClaimsPrincipal();
		var identity = new ClaimsIdentity(new Claim[] { new Claim(ClaimTypes.Name, "James Bond") }, "Test authentication");
		principal.AddIdentity(identity);

		var authenticationStateProviderMock = new Mock<AuthenticationStateProvider>();
		authenticationStateProviderMock.Setup(x => x.GetAuthenticationStateAsync()).Returns(Task.FromResult(new AuthenticationState(principal)));

		Services.AddSingleton<AuthenticationStateProvider>(authenticationStateProviderMock.Object);

		var navigationManagerMock = new Mock<NavigationManager>();
		Services.AddSingleton<NavigationManager>(navigationManagerMock.Object);

		var cut = Render(@<BlazorWebFormsComponents.LoginControls.Login @ref="loginControl" ID="loginControl" OnAuthenticate="Login_Authenticate" />);

		cut.Find("#loginControl_UserName").Change(Credential.InvalidCredential.Username);
		cut.Find("#loginControl_Password").Change(Credential.InvalidCredential.Username);
		cut.Find("form").Submit();
		cut.Markup.ShouldContain("Your login attempt was not successful");
		isAuthenticated.ShouldBeFalse();

		cut.Find("#loginControl_UserName").Change(Credential.ValidCredential.Username);
		cut.Find("#loginControl_Password").Change(Credential.ValidCredential.Password);
		cut.Find("form").Submit();
		cut.Markup.ShouldNotContain("Your login attempt was not successful");
		isAuthenticated.ShouldBeTrue();
	}

	void Login_Authenticate(AuthenticateEventArgs args)
	{
		if (loginControl.UserName == Credential.ValidCredential.Username && loginControl.Password == Credential.ValidCredential.Password)
		{
			isAuthenticated = args.Authenticated = true;
		}
		else
		{
			isAuthenticated = args.Authenticated = false;
		}
	}
}
