@inherits BunitContext
@using Microsoft.AspNetCore.Components.Authorization
@using System.Security.Claims;
@using Moq;

@code {
	bool _loggingOut = false;
	bool _loggedOut = false;

	[Fact]
	public void LoginStatus_LogoutEvent_FiresBothEvents()
	{
		var principal = new ClaimsPrincipal();
		var identity = new ClaimsIdentity(new Claim[] { new Claim(ClaimTypes.Name, "James Bond") }, "Test authentication");
		principal.AddIdentity(identity);

		var autheMock = new Mock<AuthenticationStateProvider>();
		autheMock.Setup(x => x.GetAuthenticationStateAsync()).Returns(Task.FromResult(new AuthenticationState(principal)));

		Services.AddSingleton<AuthenticationStateProvider>(autheMock.Object);

		var navMock = new Mock<NavigationManager>();
		Services.AddSingleton<NavigationManager>(navMock.Object);

		var cut = Render(@<BlazorWebFormsComponents.LoginControls.LoginStatus OnLoggingOut="LoggingOut" OnLoggedOut="LoggedOut" />);

		cut.Find("a").Click();


		_loggingOut.ShouldBeTrue();
		_loggedOut.ShouldBeTrue();
	}

	void LoggingOut(BlazorWebFormsComponents.LoginControls.LoginCancelEventArgs args)
	{
		_loggingOut = true;
	}

	void LoggedOut(EventArgs args)
	{
		_loggedOut = true;
	}
}
