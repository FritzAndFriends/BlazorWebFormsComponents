@using BlazorWebFormsComponents.DataBinding
@using BlazorWebFormsComponents.Enums
@inherits DataBoundComponent<ItemType>
@typeparam ItemType

@if (!Visible)
{
	<!-- Control is not visible -->
}
else if (Items == null || !Items.Any())
{
	@if (EmptyItemTemplate != null)
	{
		@EmptyItemTemplate
	}
	else
	{
		@EmptyDataTemplate
	}
}
else
{
	@if (LayoutTemplate is null)
	{
		LayoutTemplate = context => builder => builder.AddContent(1, context);
	}
	RaiseLayoutCreated();

	Func<bool, RenderFragment<ItemType>> oddOrEvenTemplate =
	(isEven) => isEven ? ItemTemplate : AlternatingItemTemplate ?? ItemTemplate;

	@LayoutTemplate(
			@: @if (Items != null)
			{
				var even = true;
				var isBusy = true;
				var itemIterator = Items.GetEnumerator();
				itemIterator.Reset();
				itemIterator.MoveNext();
				if (GroupItemCount == 0)
				{
					DataBinding(EventArgs.Empty);

					@if (InsertItemPosition != InsertItemPosition.None && InsertItemPosition == InsertItemPosition.FirstItem && InsertItemTemplate != null)
					{
						@InsertItemTemplate(default(ItemType))
					}

					var dataItemIndex = 0;
					var displayIndex = 0;
					foreach(var item in Items)
					{
						var listViewDataItem = new ListViewDataItem(dataItemIndex, displayIndex)
						{
							DataItem = item
						};
						<CascadingValue Name="CurrentDataBoundItem" Value="item">
							@{
								var currentTemplate = (EditIndex >= 0 && dataItemIndex == EditIndex && EditItemTemplate != null)
									? EditItemTemplate : oddOrEvenTemplate(even);
							}
							@currentTemplate(item)
							@{ even = !even; }
						</CascadingValue>
						if (ItemSeparatorTemplate != null)
						{
							@ItemSeparatorTemplate
						}

						ItemDataBound(new ListViewItemEventArgs(listViewDataItem) { Sender = this });
						dataItemIndex++;
						displayIndex++;
					}

					@if (InsertItemPosition != InsertItemPosition.None && InsertItemPosition == InsertItemPosition.LastItem && InsertItemTemplate != null)
					{
						@InsertItemTemplate(default(ItemType))
					}

					DataBound(EventArgs.Empty);
				}
				else
				{
					var buildCounter = 1;
					var dataItemIndex = 0;
					var displayIndex = 0;

					DataBinding(EventArgs.Empty);

					do
					{
						RenderFragment renderFragment = builder =>
						{
							builder.OpenRegion(buildCounter);
							buildCounter++;
							for (var i = 0; i < GroupItemCount ; i++)
							{
								var builderTemplate = (EditIndex >= 0 && dataItemIndex == EditIndex && EditItemTemplate != null)
									? EditItemTemplate : oddOrEvenTemplate(even);
								var item = itemIterator.Current;
								if (item != null)
								{
									var listViewDataItem = new ListViewDataItem(dataItemIndex, displayIndex)
									{
										DataItem = item
									};
									<CascadingValue Name="CurrentDataBoundItem" Value="item">
										@builderTemplate(item)
									</CascadingValue>

									ItemDataBound(new ListViewItemEventArgs(listViewDataItem) { Sender = this });
									dataItemIndex++;
									displayIndex++;
								}
								if (ItemSeparatorTemplate != null && i < GroupItemCount - 1)
								{
									builder.AddContent(buildCounter, @ItemSeparatorTemplate);
									buildCounter++;
								}

								isBusy = itemIterator.MoveNext();
								even = !even;
							}

							builder.CloseRegion();
						};

						@GroupTemplate(renderFragment);
						if (isBusy)
						{
							@GroupSeparatorTemplate
						}
						
					} while (isBusy);

					DataBound(EventArgs.Empty);
				}
			}
		)
}
